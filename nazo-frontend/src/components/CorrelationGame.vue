<template>
  <div
    class="min-h-screen bg-gradient-to-br from-indigo-500 via-purple-600 to-purple-800 flex items-center justify-center p-4"
  >
    <div
      class="bg-white/95 rounded-2xl p-6 shadow-2xl backdrop-blur-lg max-w-6xl w-full"
    >
      <div class="flex flex-col lg:flex-row gap-8 items-start justify-center">
        <!-- Êï£ÁÇπÂõæÂå∫Âüü -->
        <div class="relative">
          <div
            class="bg-white rounded-lg p-4 shadow-lg border-4 border-gray-300"
          >
            <canvas
              ref="scatterPlot"
              width="400"
              height="400"
              class="border border-gray-200 rounded bg-gray-50"
            ></canvas>
          </div>
        </div>

        <!-- Ê∏∏Êàè‰ø°ÊÅØÈù¢Êùø -->
        <div class="min-w-[300px] space-y-4">
          <!-- ËµÑÊ∫êÊòæÁ§∫Âå∫ -->
          <div class="flex gap-4 mb-6">
            <div
              class="bg-white/80 p-3 rounded-lg shadow-md flex items-center space-x-2"
            >
              <span class="text-2xl">‚ù§Ô∏è</span>
              <span class="text-xl font-bold text-red-600">{{ lives }}</span>
            </div>
            <div
              class="bg-white/80 p-3 rounded-lg shadow-md flex items-center space-x-2"
            >
              <span class="text-2xl">üí∞</span>
              <span class="text-xl font-bold text-yellow-600">{{ coins }}</span>
            </div>
          </div>

          <!-- ËøûÂáªÂíåÂπ≥ÂùáËØØÂ∑Æ -->
          <div class="bg-white/80 p-4 rounded-lg shadow-md">
            <h3
              class="text-sm font-bold text-gray-600 mb-2 uppercase tracking-wide"
            >
              STREAKS
            </h3>
            <div class="text-2xl font-bold text-gray-800 text-center">
              {{ streaks }}
            </div>
          </div>

          <div class="bg-white/80 p-4 rounded-lg shadow-md">
            <h3
              class="text-sm font-bold text-gray-600 mb-2 uppercase tracking-wide"
            >
              SCORE
            </h3>
            <div class="text-2xl font-bold text-gray-800 text-center">
              {{ score }}
            </div>
          </div>

          <div class="bg-white/80 p-4 rounded-lg shadow-md">
            <h3
              class="text-sm font-bold text-gray-600 mb-2 uppercase tracking-wide"
            >
              MEAN ERROR
            </h3>
            <div class="text-2xl font-bold text-gray-800 text-center">
              {{ meanError.toFixed(3) }}
            </div>
          </div>

          <!-- Ê∏∏ÊàèÁä∂ÊÄÅÂå∫Âüü -->
          <div class="bg-white/80 p-4 rounded-lg shadow-md min-h-[200px]">
            <!-- Á≠âÂæÖËæìÂÖ•Áä∂ÊÄÅ -->
            <div v-if="gameState === 'waiting'" class="space-y-4">
              <h3 class="text-lg font-bold text-gray-700 text-center">
                GUESS THE CORRELATION
              </h3>
              <p class="text-sm text-gray-600 text-center">
                Enter a value between 0 and 1
              </p>
              <div class="space-y-3">
                <input
                  v-model="guessInput"
                  type="number"
                  step="0.001"
                  min="0"
                  max="1"
                  placeholder="0.000"
                  class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none text-center"
                  @keyup.enter="submitGuess"
                />
                <button
                  @click="submitGuess"
                  :disabled="!isValidGuess"
                  class="w-full py-3 bg-blue-500 text-white rounded-lg hover:bg-blue-600 disabled:bg-gray-400 disabled:cursor-not-allowed transform hover:-translate-y-1 transition-all duration-300 font-bold uppercase tracking-wide shadow-lg"
                >
                  SUBMIT GUESS
                </button>
              </div>
            </div>

            <!-- ÁåúÂØπÁä∂ÊÄÅ -->
            <div
              v-else-if="gameState === 'correct'"
              class="space-y-4 text-center"
            >
              <h3 class="text-xl font-bold text-green-600">CORRECT! üéâ</h3>
              <div class="space-y-2 text-sm">
                <p><strong>TRUE R:</strong> {{ trueR.toFixed(3) }}</p>
                <p><strong>GUESSED R:</strong> {{ lastGuess.toFixed(3) }}</p>
                <p>
                  <strong>DIFFERENCE:</strong>
                  {{ Math.abs(trueR - lastGuess).toFixed(3) }}
                </p>
              </div>
              <div class="text-lg">
                <span class="text-red-500">‚ù§Ô∏è+1</span>
                <span class="text-yellow-500 ml-2">üí∞+{{ lastReward }}</span>
              </div>
              <button
                @click="nextRound"
                class="w-full py-3 bg-green-500 text-white rounded-lg hover:bg-green-600 transform hover:-translate-y-1 transition-all duration-300 font-bold uppercase tracking-wide shadow-lg"
              >
                NEXT
              </button>
            </div>

            <!-- ÁåúÈîôÁä∂ÊÄÅ -->
            <div
              v-else-if="gameState === 'wrong'"
              class="space-y-4 text-center"
            >
              <h3 class="text-xl font-bold text-red-600">WRONG! üò¢</h3>
              <div class="space-y-2 text-sm">
                <p><strong>TRUE R:</strong> {{ trueR.toFixed(3) }}</p>
                <p><strong>GUESSED R:</strong> {{ lastGuess.toFixed(3) }}</p>
                <p>
                  <strong>DIFFERENCE:</strong>
                  {{ Math.abs(trueR - lastGuess).toFixed(3) }}
                </p>
              </div>
              <div class="text-lg">
                <span class="text-red-500">‚ù§Ô∏è-1</span>
              </div>
              <button
                @click="nextRound"
                class="w-full py-3 bg-orange-500 text-white rounded-lg hover:bg-orange-600 transform hover:-translate-y-1 transition-all duration-300 font-bold uppercase tracking-wide shadow-lg"
              >
                NEXT
              </button>
            </div>

            <!-- Ê∏∏ÊàèÁªìÊùüÁä∂ÊÄÅ -->
            <div
              v-else-if="gameState === 'gameOver'"
              class="space-y-4 text-center"
            >
              <h2 class="text-2xl font-bold text-red-600">GAME OVER</h2>
              <div class="space-y-2">
                <p class="text-lg"><strong>SCORE:</strong> {{ score }}</p>
                <p class="text-lg"><strong>BEST:</strong> {{ bestScore }}</p>
                <p
                  v-if="isNewHighScore"
                  class="text-xl font-bold text-yellow-600 animate-pulse"
                >
                  NEW HIGHSCORE! üèÜ
                </p>
              </div>
              <button
                @click="playAgain"
                class="w-full py-3 bg-purple-500 text-white rounded-lg hover:bg-purple-600 transform hover:-translate-y-1 transition-all duration-300 font-bold uppercase tracking-wide shadow-lg"
              >
                PLAY AGAIN
              </button>
            </div>
          </div>

          <!-- Ë∞ÉËØïÈù¢Êùø (‰ªÖÂºÄÂèëÁéØÂ¢É) -->
          <div
            v-if="isDevelopment"
            class="bg-white/80 p-4 rounded-lg shadow-md border-2 border-red-500/30"
          >
            <h3
              class="text-lg font-bold text-red-600 mb-4 flex items-center space-x-2"
            >
              <span>üêõ</span>
              <span>Ë∞ÉËØïÈù¢Êùø</span>
            </h3>

            <div class="space-y-3">
              <!-- Âø´ÈÄüËÆæÁΩÆÂàÜÊï∞ÊåâÈíÆ -->
              <div class="grid grid-cols-2 gap-2">
                <button
                  @click="setScore(10)"
                  class="px-3 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded text-sm"
                >
                  10ÂàÜ
                </button>
                <button
                  @click="setScore(30)"
                  class="px-3 py-2 bg-yellow-600 hover:bg-yellow-700 text-white rounded text-sm"
                >
                  30ÂàÜ
                </button>
                <button
                  @click="setScore(50)"
                  class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm"
                >
                  50ÂàÜ(ÈÄöÂÖ≥)
                </button>
                <button
                  @click="setScore(100)"
                  class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm"
                >
                  100ÂàÜ
                </button>
              </div>

              <!-- Áõ¥Êé•ËæìÂÖ•ÂàÜÊï∞ -->
              <div class="flex space-x-2">
                <input
                  v-model.number="debugScore"
                  type="number"
                  placeholder="ËæìÂÖ•ÂàÜÊï∞"
                  class="flex-1 px-3 py-2 bg-gray-200 border border-gray-300 rounded text-black text-sm"
                />
                <button
                  @click="setScore(debugScore)"
                  class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded text-sm"
                >
                  ËÆæÁΩÆ
                </button>
              </div>

              <!-- ÁîüÂëΩÂÄºÊéßÂà∂ -->
              <div class="grid grid-cols-3 gap-2">
                <button
                  @click="setLives(1)"
                  class="px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded text-sm"
                >
                  1‚ù§Ô∏è
                </button>
                <button
                  @click="setLives(2)"
                  class="px-3 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded text-sm"
                >
                  2‚ù§Ô∏è
                </button>
                <button
                  @click="setLives(3)"
                  class="px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded text-sm"
                >
                  3‚ù§Ô∏è
                </button>
              </div>

              <!-- ÊµãËØïÂäüËÉΩ -->
              <button
                @click="testGameComplete"
                class="w-full px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded text-sm"
              >
                ÊµãËØïÈÄöÂÖ≥Ê£ÄÊµã
              </button>

              <!-- Ê∏∏ÊàèÁä∂ÊÄÅÈáçÁΩÆ -->
              <button
                @click="resetGame"
                class="w-full px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded text-sm"
              >
                ÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- ÈîôËØØÂºπÁ™ó -->
    <div
      v-if="showErrorModal"
      class="fixed inset-0 bg-black/50 flex items-center justify-center z-50 backdrop-blur-sm"
    >
      <div class="bg-white rounded-2xl p-6 shadow-2xl max-w-md w-full mx-4">
        <div class="text-center">
          <div class="text-6xl mb-4">‚ö†Ô∏è</div>
          <h2 class="text-2xl font-bold text-red-600 mb-4">ËØ∑Ê±ÇÂ§±Ë¥•</h2>
          <p class="text-gray-600 mb-6">{{ errorMessage }}</p>
          <button
            @click="closeErrorModal"
            class="px-6 py-3 bg-red-500 text-white rounded-lg hover:bg-red-600 transform hover:-translate-y-1 transition-all duration-300 font-bold uppercase tracking-wide shadow-lg"
          >
            Á°ÆÂÆö
          </button>
        </div>
      </div>
    </div>
  </div>
</template>

<script setup lang="ts">
import { ref, onMounted, computed, nextTick, watch } from "vue";
import { useRouter, useRoute } from "vue-router";
import { startGame, completeGame } from "@/services/api";

const router = useRouter();
const route = useRoute();

// ÂÆö‰πâ props
interface Props {
  levelUuid: string;
}

const props = defineProps<Props>();

// ÂÆö‰πâ emit ‰∫ã‰ª∂
const emit = defineEmits<{
  gameComplete: [
    data: { success: boolean; message: string; nextLevel?: string }
  ];
}>();

// Ëé∑ÂèñÁî®Êà∑‰ø°ÊÅØÂíå‰ºöËØù
const username = ref(localStorage.getItem("nazo_user") || "");
const sessionId = ref("");

// Ê∏∏ÊàèÁä∂ÊÄÅ
const gameState = ref<"waiting" | "correct" | "wrong" | "gameOver">("waiting");
const lives = ref(3);
const coins = ref(0);
const streaks = ref(0);
const meanError = ref(0);
const score = ref(0);
const bestScore = ref(0);
const isNewHighScore = ref(false);

// Êï£ÁÇπÂõæÊï∞ÊçÆ
const scatterData = ref<{ x: number; y: number }[]>([]);
const trueR = ref(0);
const guessInput = ref("");
const lastGuess = ref(0);
const lastReward = ref(0);

// ÁªüËÆ°Êï∞ÊçÆ
const totalGuesses = ref(0);
const totalError = ref(0);

// Ë∞ÉËØïÁõ∏ÂÖ≥ÂèòÈáè
const isDevelopment = ref(import.meta.env.DEV);
const debugScore = ref(0);

// ÈîôËØØÂ§ÑÁêÜÁä∂ÊÄÅ
const showErrorModal = ref(false);
const errorMessage = ref("");

const scatterPlot = ref<HTMLCanvasElement>();

// ËÆ°ÁÆóÂ±ûÊÄß
const isValidGuess = computed(() => {
  const value = parseFloat(guessInput.value);
  return !isNaN(value) && value >= 0 && value <= 1;
});

// ÂÆûÊó∂ÁõëÂê¨ÂàÜÊï∞ÂèòÂåñÔºåËææÂà∞ÈòàÂÄºËá™Âä®ÈÄöÂÖ≥
watch(score, (newScore) => {
  if (
    newScore >= 50 &&
    sessionId.value &&
    username.value &&
    gameState.value !== "gameOver"
  ) {
    // Âª∂Ëøü‰∏ÄÁÇπÂÜçÊ£ÄÊµãÔºåÈÅøÂÖçÂú®Ê≠£Âú®Êèê‰∫§Êó∂ÈáçÂ§çËß¶Âèë
    setTimeout(() => {
      autoCompleteGame();
    }, 500);
  }
});

// ÂàùÂßãÂåñÊ∏∏Êàè
onMounted(async () => {
  loadBestScore();
  generateNewScatterPlot();

  // Â¶ÇÊûúÊòØÈÄöËøáÂÖ≥Âç°Á≥ªÁªüËøõÂÖ•ÔºåÂàùÂßãÂåñÊ∏∏Êàè‰ºöËØù
  if (props.levelUuid && username.value) {
    try {
      const response = await startGame(props.levelUuid);
      if (response.success && response.sessionId) {
        sessionId.value = response.sessionId;
      }
    } catch (error) {
      console.error("Failed to start game session:", error);
    }
  }
});

// ÁîüÊàêÊñ∞ÁöÑÊï£ÁÇπÂõæ
function generateNewScatterPlot() {
  const points: { x: number; y: number }[] = [];
  const numPoints = 30 + Math.floor(Math.random() * 20); // 30-50‰∏™ÁÇπ

  // ÈöèÊú∫ÁîüÊàêÁõ∏ÂÖ≥ÊÄßÂº∫Â∫¶
  const correlationStrength = Math.random() * 2 - 1; // -1 to 1
  const noise = 0.1 + Math.random() * 0.4; // Âô™Â£∞Ê∞¥Âπ≥

  for (let i = 0; i < numPoints; i++) {
    const x = Math.random();
    // Âü∫‰∫éÁõ∏ÂÖ≥ÊÄßÁîüÊàêyÂÄºÔºåÂä†‰∏äÂô™Â£∞
    let y =
      correlationStrength * x +
      (1 - Math.abs(correlationStrength)) * Math.random();
    y += (Math.random() - 0.5) * noise;

    // Á°Æ‰øùyÂú®0-1ËåÉÂõ¥ÂÜÖ
    y = Math.max(0, Math.min(1, y));

    points.push({ x, y });
  }

  scatterData.value = points;
  trueR.value = calculateCorrelation(points);

  nextTick(() => {
    drawScatterPlot();
  });
}

// ËÆ°ÁÆóÁöÆÂ∞îÈÄäÁõ∏ÂÖ≥Á≥ªÊï∞
function calculateCorrelation(points: { x: number; y: number }[]): number {
  const n = points.length;
  if (n === 0) return 0;

  const sumX = points.reduce((sum, p) => sum + p.x, 0);
  const sumY = points.reduce((sum, p) => sum + p.y, 0);
  const sumXY = points.reduce((sum, p) => sum + p.x * p.y, 0);
  const sumX2 = points.reduce((sum, p) => sum + p.x * p.x, 0);
  const sumY2 = points.reduce((sum, p) => sum + p.y * p.y, 0);

  const numerator = n * sumXY - sumX * sumY;
  const denominator = Math.sqrt(
    (n * sumX2 - sumX * sumX) * (n * sumY2 - sumY * sumY)
  );

  if (denominator === 0) return 0;
  return numerator / denominator;
}

// ÁªòÂà∂Êï£ÁÇπÂõæ
function drawScatterPlot() {
  if (!scatterPlot.value) return;

  const canvas = scatterPlot.value;
  const ctx = canvas.getContext("2d");
  if (!ctx) return;

  // Ê∏ÖÁ©∫ÁîªÂ∏É
  ctx.clearRect(0, 0, canvas.width, canvas.height);

  // ÁªòÂà∂ÂùêÊ†áËΩ¥
  ctx.strokeStyle = "#666";
  ctx.lineWidth = 2;

  // XËΩ¥
  ctx.beginPath();
  ctx.moveTo(40, canvas.height - 40);
  ctx.lineTo(canvas.width - 20, canvas.height - 40);
  ctx.stroke();

  // YËΩ¥
  ctx.beginPath();
  ctx.moveTo(40, 20);
  ctx.lineTo(40, canvas.height - 40);
  ctx.stroke();

  // ÁªòÂà∂ÂàªÂ∫¶Ê†áÁ≠æ
  ctx.fillStyle = "#666";
  ctx.font = "12px Arial";
  ctx.textAlign = "center";

  // XËΩ¥Ê†áÁ≠æ
  ctx.fillText("0", 40, canvas.height - 20);
  ctx.fillText("0.5", (canvas.width - 60) / 2 + 40, canvas.height - 20);
  ctx.fillText("1", canvas.width - 20, canvas.height - 20);

  // YËΩ¥Ê†áÁ≠æ
  ctx.textAlign = "right";
  ctx.fillText("0", 30, canvas.height - 35);
  ctx.fillText("0.5", 30, (canvas.height - 60) / 2 + 20);
  ctx.fillText("1", 30, 25);

  // ÁªòÂà∂Êï£ÁÇπ
  const plotWidth = canvas.width - 60;
  const plotHeight = canvas.height - 60;

  ctx.fillStyle = "#3b82f6";
  scatterData.value.forEach((point) => {
    const x = 40 + point.x * plotWidth;
    const y = canvas.height - 40 - point.y * plotHeight;

    ctx.beginPath();
    ctx.arc(x, y, 4, 0, 2 * Math.PI);
    ctx.fill();
  });
}

// Êèê‰∫§ÁåúÊµã
function submitGuess() {
  if (!isValidGuess.value) return;

  const guess = parseFloat(guessInput.value);
  lastGuess.value = guess;
  const difference = Math.abs(trueR.value - guess);

  // Êõ¥Êñ∞ÁªüËÆ°
  totalGuesses.value++;
  totalError.value += difference;
  meanError.value = totalError.value / totalGuesses.value;

  // Âà§Êñ≠Ê≠£Á°ÆÊÄßÔºàËØØÂ∑ÆÂ∞è‰∫é0.1ÁÆóÊ≠£Á°ÆÔºâ
  const threshold = 0.1;
  if (difference <= threshold) {
    // ÁåúÂØπ
    lives.value = Math.min(lives.value + 1, 3); // ÈôêÂà∂ÊúÄÂ§ßÁîüÂëΩÂÄº‰∏∫3
    const reward = Math.max(1, Math.floor((threshold - difference) * 50));
    coins.value += reward;
    lastReward.value = reward;
    streaks.value++;
    score.value += 10 + reward;
    gameState.value = "correct";
  } else {
    // ÁåúÈîô
    lives.value--;
    streaks.value = 0;
    gameState.value = "wrong";

    if (lives.value <= 0) {
      gameState.value = "gameOver";
      checkNewHighScore();
    }
  }

  guessInput.value = "";
}

// ‰∏ã‰∏ÄËΩÆ
function nextRound() {
  if (lives.value <= 0) {
    gameState.value = "gameOver";
    return;
  }

  generateNewScatterPlot();
  gameState.value = "waiting";
}

// Ëá™Âä®ÂÆåÊàêÊ∏∏ÊàèÔºàËææÂà∞ÈòàÂÄºÊó∂Ë∞ÉÁî®Ôºâ
const isSubmitting = ref(false);

async function autoCompleteGame() {
  if (isSubmitting.value) return;

  isSubmitting.value = true;

  try {
    const response = await completeGame(
      props.levelUuid,
      sessionId.value,
      score.value
    );

    if (response.success && response.nextLevel) {
      // ÂèëÈÄÅÊ∏∏ÊàèÂÆåÊàê‰∫ã‰ª∂
      emit("gameComplete", {
        success: true,
        message: `ÊÅ≠ÂñúÔºÅÊÇ®‰ª• ${score.value} ÂàÜÁöÑÊàêÁª©ÈÄöÂÖ≥‰∫ÜÔºÅ`,
        nextLevel: response.nextLevel,
      });
    } else {
      // ÊòæÁ§∫ÊúçÂä°Âô®ËøîÂõûÁöÑÈîôËØØ‰ø°ÊÅØ
      showErrorMessage(response.message || "Ê∏∏ÊàèÂÆåÊàêËØ∑Ê±ÇÂ§±Ë¥•ÔºåËØ∑Á®çÂêéÈáçËØï");
    }
  } catch (error: any) {
    console.error("Failed to complete game:", error);
    // ÊòæÁ§∫ÁΩëÁªúÊàñÂÖ∂‰ªñÈîôËØØ
    const errorMsg =
      error?.message ||
      error?.response?.data?.error ||
      "ÁΩëÁªúËøûÊé•Â§±Ë¥•ÔºåËØ∑Ê£ÄÊü•ÁΩëÁªúÂêéÈáçËØï";
    showErrorMessage(errorMsg);
  } finally {
    isSubmitting.value = false;
  }
}

// Ê£ÄÊü•Êñ∞ËÆ∞ÂΩïÂíåÈÄöÂÖ≥Êù°‰ª∂
async function checkNewHighScore() {
  if (score.value > bestScore.value) {
    bestScore.value = score.value;
    isNewHighScore.value = true;
    saveBestScore();
  } else {
    isNewHighScore.value = false;
  }

  // Ê£ÄÊü•ÊòØÂê¶ËææÂà∞ÈÄöÂÖ≥Êù°‰ª∂Ôºà50ÂàÜÔºâÂπ∂‰∏îÊúâÊúâÊïà‰ºöËØù
  if (score.value >= 50 && sessionId.value && username.value) {
    autoCompleteGame();
  }
}

// ÈáçÊñ∞ÂºÄÂßãÊ∏∏Êàè
function playAgain() {
  lives.value = 3;
  coins.value = 0;
  streaks.value = 0;
  score.value = 0;
  totalGuesses.value = 0;
  totalError.value = 0;
  meanError.value = 0;
  isNewHighScore.value = false;
  generateNewScatterPlot();
  gameState.value = "waiting";
}

// ËøîÂõû‰∏ªËèúÂçï
function goToMainMenu() {
  router.push("/login");
}

// Êú¨Âú∞Â≠òÂÇ®ÊúÄ‰Ω≥ÊàêÁª©
function saveBestScore() {
  localStorage.setItem(
    "correlation_game_best_score",
    bestScore.value.toString()
  );
}

function loadBestScore() {
  const saved = localStorage.getItem("correlation_game_best_score");
  if (saved) {
    bestScore.value = parseInt(saved);
  }
}

// Ë∞ÉËØïÂáΩÊï∞ÔºöËÆæÁΩÆÂàÜÊï∞
function setScore(newScore: number) {
  if (isDevelopment.value && typeof newScore === "number" && newScore >= 0) {
    score.value = newScore;
    console.log(`Ë∞ÉËØïÔºöÂàÜÊï∞Â∑≤ËÆæÁΩÆ‰∏∫ ${newScore}`);
  }
}

// Ë∞ÉËØïÂáΩÊï∞ÔºöËÆæÁΩÆÁîüÂëΩÂÄº
function setLives(newLives: number) {
  if (
    isDevelopment.value &&
    typeof newLives === "number" &&
    newLives >= 0 &&
    newLives <= 3
  ) {
    lives.value = newLives;
    console.log(`Ë∞ÉËØïÔºöÁîüÂëΩÂÄºÂ∑≤ËÆæÁΩÆ‰∏∫ ${newLives}`);
  }
}

// Ë∞ÉËØïÂáΩÊï∞ÔºöÊµãËØïÈÄöÂÖ≥Ê£ÄÊµã
function testGameComplete() {
  if (isDevelopment.value) {
    console.log(
      `ÂΩìÂâçÂàÜÊï∞: ${score.value}, ÈÄöÂÖ≥Êù°‰ª∂: 50, ÊòØÂê¶ÈÄöÂÖ≥: ${score.value >= 50}`
    );
    if (score.value >= 50) {
      console.log("Êª°Ë∂≥ÈÄöÂÖ≥Êù°‰ª∂ÔºÅ");
      autoCompleteGame();
    } else {
      console.log("Êú™Êª°Ë∂≥ÈÄöÂÖ≥Êù°‰ª∂");
    }
  }
}

// Ë∞ÉËØïÂáΩÊï∞ÔºöÈáçÁΩÆÊ∏∏ÊàèÁä∂ÊÄÅ
function resetGame() {
  if (isDevelopment.value) {
    playAgain();
    console.log("Ê∏∏ÊàèÁä∂ÊÄÅÂ∑≤ÈáçÁΩÆ");
  }
}

// ÂÖ≥Èó≠ÈîôËØØÂºπÁ™ó
function closeErrorModal() {
  showErrorModal.value = false;
  errorMessage.value = "";
}

// ÊòæÁ§∫ÈîôËØØÂºπÁ™ó
function showErrorMessage(message: string) {
  errorMessage.value = message;
  showErrorModal.value = true;
}
</script>

<style scoped>
.animate-pulse {
  animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
}

@keyframes pulse {
  0%,
  100% {
    opacity: 1;
  }
  50% {
    opacity: 0.5;
  }
}
</style>
